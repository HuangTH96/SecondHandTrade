# 卡鲁二手哥

一个简单易用的二手物品交易平台。

## 最新更新

1. **用户系统升级**：
   - 新增用户注册功能，需要用户名和密码
   - 用户名不区分大小写，自动清除空格
   - 用户名查重功能，避免重复注册
   - 未登录用户可以浏览物品，但无法查看用户信息
   - 需要管理员授权才能发布物品和查看其他用户

2. **用户状态优化**：
   - 实时显示用户在线/离线状态
   - 退出登录时立即更新用户状态
   - 在线状态自动更新（5分钟无活动视为离线）

3. **界面优化**：
   - 优化用户列表显示，改为侧边栏形式
   - 可随时展开/收起用户列表
   - 清晰区分在线和离线用户
   - 将删除账户功能移至个人主页

## 功能特点

### 用户系统
- 用户注册和登录：
  * 需要用户名和密码
  * 用户名不区分大小写，自动清除空格
  * 用户名唯一性检查
  * 密码加密存储
- 用户授权：
  * 管理员可以授权/取消授权用户
  * 未登录用户只能浏览物品
  * 未授权用户可以浏览物品，但不能查看用户信息
  * 已授权用户可以发布物品和查看其他用户
  * 管理员账户（用户名：admin）自动获得授权权限
  * 管理员可以在用户列表页面管理授权状态
  * 授权状态实时显示，使用不同颜色标识
- 在线状态显示：显示用户是否在线（5分钟内活动视为在线）
- 用户主页：展示用户发布的在售和已售物品
- 隐私设置：可控制是否向其他用户显示已售物品
- 账户管理：支持账户删除（自动清理相关数据）

### 物品管理
- 物品发布
  * 标题和描述
  * 价格设置
  * 图片上传
  * 类别选择（办公、生活、娱乐、学习资料）
- 物品状态
  * 在售状态
  * 已预定状态
  * 已售出状态
- 自动数据清理
  * 删除物品时自动删除对应图片
  * 删除账户时自动清理所有相关数据

### 预定系统
- 72小时预定期限
  * 实时倒计时显示
  * 过期自动取消预定
- 预定管理
  * 查看已预定物品列表
  * 按剩余时间排序显示
  * 显示预定物品总数和总价
  * 支持取消预定
- 并发预定处理
  * 使用数据库事务确保预定操作的原子性
  * 实现记录锁定，防止多用户同时预定
  * 完善的错误处理和用户提示
  * 自动回滚失败的预定操作

### 搜索功能
- 支持模糊搜索物品名称
- 实时显示搜索结果
- 仅显示在售物品

### 用户界面
- 响应式布局，适配各种屏幕尺寸
- 清晰的导航系统
  * 首页
  * 用户列表（可隐藏的侧边栏）
  * 个人主页
  * 我的预定
  * 物品上传
- 美观的卡片式布局
- 直观的状态显示
- 友好的操作提示

## 技术栈

- Python 3.8
- Flask 2.0.1
- SQLAlchemy
- SQLite

## 安装和运行

1. 创建并激活 conda 环境：
```bash
conda env create -f environment.yml
conda activate secondhand-trade
```

2. 运行应用：
```bash
python app.py
```

首次运行时会自动创建数据库文件（`instance/items.db`）。如果遇到数据库问题，可以：
- 删除 `instance/items.db` 文件重新创建数据库
- 或者直接重启应用，数据库会自动更新

3. 访问网站：
打开浏览器访问 http://localhost:5000

## 目录结构

```
.
├── app.py              # 主应用文件
├── requirements.txt    # pip 依赖
├── environment.yml     # conda 环境配置
├── static/            # 静态文件
│   ├── css/          # 样式文件
│   └── uploads/      # 上传的图片
└── templates/         # 模板文件
    ├── index.html    # 首页
    ├── login.html    # 登录页
    ├── upload.html   # 上传页
    ├── users.html    # 用户列表
    ├── user_profile.html  # 用户主页
    └── my_reservations.html  # 预定管理页
```

## 使用说明

1. 用户管理
   - 新用户注册：
     * 输入用户名（不区分大小写）和密码
     * 系统自动检查用户名是否已被使用
     * 注册成功后需要登录
   - 用户权限：
     * 未登录用户：可以浏览物品
     * 未授权用户：可以浏览物品，但不能查看用户信息
     * 已授权用户：可以发布物品、预定物品、查看其他用户
   - 管理员账户设置：
     * 使用用户名 "admin" 注册即可成为管理员
     * 管理员账户自动获得所有权限
     * 管理员可以在用户列表页面授权/取消授权其他用户
     * 管理员账户不能被其他用户取消授权
   - 账户管理：
     * 在个人主页可以删除账户
     * 删除账户会自动清理所有相关数据
     * 可以控制是否向其他用户显示已售物品

2. 物品管理
   - 上传物品时需要提供标题、描述、价格、类别和图片
   - 可以将物品标记为已售出
   - 可以删除自己发布的物品

3. 预定功能
   - 可以预定其他用户发布的物品
   - 预定后有72小时的有效期
   - 可以查看自己预定的所有物品
   - 可以取消预定
   - 系统自动处理并发预定，确保每个物品只能被一个用户预定

4. 隐私设置
   - 可以控制是否向其他用户显示已售出的物品
   - 用户在线状态自动更新

## 贡献

欢迎提交 Issue 和 Pull Request。

## 许可证

MIT License 